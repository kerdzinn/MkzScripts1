-- Universal ESP Box Script for Roblox
-- Coloque em um LocalScript no StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local localPlayer = Players.LocalPlayer
local espObjects = {}

-- Configurações
local ESP_SETTINGS = {
    ENABLED = true,
    SHOW_BOX = true,
    SHOW_NAME = true,
    SHOW_DISTANCE = true,
    SHOW_TRACER = false,
    TEAM_CHECK = true,
    MAX_DISTANCE = 1000,
    
    BOX_COLOR_ENEMY = Color3.fromRGB(255, 0, 0),
    BOX_COLOR_TEAM = Color3.fromRGB(0, 255, 0),
    BOX_COLOR_NEUTRAL = Color3.fromRGB(255, 255, 0),
    
    TEXT_COLOR = Color3.fromRGB(255, 255, 255),
    TEXT_SIZE = 14,
    TEXT_FONT = Enum.Font.GothamBold,
    
    TRACER_COLOR = Color3.fromRGB(255, 255, 255),
    TRACER_THICKNESS = 1
}

-- Função para verificar se o player é inimigo
local function isEnemy(player)
    if not ESP_SETTINGS.TEAM_CHECK then return true end
    if not localPlayer.Team then return true end
    if not player.Team then return true end
    return localPlayer.Team ~= player.Team
end

-- Função para calcular distância
local function getDistance(position)
    local character = localPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return 0
    end
    return math.floor((character.HumanoidRootPart.Position - position).Magnitude)
end

-- Função para criar ESP para um player
local function createESP(player)
    if espObjects[player] then return end
    
    espObjects[player] = {
        box = nil,
        nameLabel = nil,
        distanceLabel = nil,
        tracer = nil
    }
    
    -- Aguardar character carregar
    repeat wait() until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    
    local character = player.Character
    local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    -- Criar Box
    if ESP_SETTINGS.SHOW_BOX then
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "ESPBox"
        box.Adornee = humanoidRootPart
        box.AlwaysOnTop = true
        box.ZIndex = 1
        box.Size = Vector3.new(4, 6, 4)
        box.Transparency = 0.7
        box.Parent = CoreGui
        espObjects[player].box = box
    end
    
    -- Criar Label do Nome
    if ESP_SETTINGS.SHOW_NAME then
        local nameLabel = Instance.new("BillboardGui")
        local textLabel = Instance.new("TextLabel")
        
        nameLabel.Name = "ESPName"
        nameLabel.Adornee = humanoidRootPart
        nameLabel.AlwaysOnTop = true
        nameLabel.Size = UDim2.new(0, 200, 0, 50)
        nameLabel.StudsOffset = Vector3.new(0, 3.5, 0)
        
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.Text = player.Name
        textLabel.TextColor3 = ESP_SETTINGS.TEXT_COLOR
        textLabel.TextSize = ESP_SETTINGS.TEXT_SIZE
        textLabel.TextStrokeTransparency = 0
        textLabel.Font = ESP_SETTINGS.TEXT_FONT
        textLabel.Parent = nameLabel
        
        nameLabel.Parent = CoreGui
        espObjects[player].nameLabel = nameLabel
    end
    
    -- Criar Label de Distância
    if ESP_SETTINGS.SHOW_DISTANCE then
        local distanceLabel = Instance.new("BillboardGui")
        local textLabel = Instance.new("TextLabel")
        
        distanceLabel.Name = "ESPDistance"
        distanceLabel.Adornee = humanoidRootPart
        distanceLabel.AlwaysOnTop = true
        distanceLabel.Size = UDim2.new(0, 200, 0, 50)
        distanceLabel.StudsOffset = Vector3.new(0, 2, 0)
        
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextColor3 = ESP_SETTINGS.TEXT_COLOR
        textLabel.TextSize = ESP_SETTINGS.TEXT_SIZE - 2
        textLabel.TextStrokeTransparency = 0
        textLabel.Font = ESP_SETTINGS.TEXT_FONT
        textLabel.Parent = distanceLabel
        
        distanceLabel.Parent = CoreGui
        espObjects[player].distanceLabel = distanceLabel
    end
    
    -- Criar Tracer
    if ESP_SETTINGS.SHOW_TRACER then
        local tracer = Instance.new("Frame")
        tracer.Name = "ESPTracer"
        tracer.BackgroundColor3 = ESP_SETTINGS.TRACER_COLOR
        tracer.BorderSizePixel = 0
        tracer.Size = UDim2.new(0, 1, 0, 1)
        tracer.Visible = false
        tracer.Parent = CoreGui
        espObjects[player].tracer = tracer
    end
end

-- Função para remover ESP
local function removeESP(player)
    if espObjects[player] then
        for _, obj in pairs(espObjects[player]) do
            if obj and obj.Parent then
                obj:Destroy()
            end
        end
        espObjects[player] = nil
    end
end

-- Função para atualizar ESP
local function updateESP()
    for player, espData in pairs(espObjects) do
        if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local character = player.Character
            local humanoidRootPart = character.HumanoidRootPart
            local distance = getDistance(humanoidRootPart.Position)
            
            -- Verificar distância máxima
            if distance > ESP_SETTINGS.MAX_DISTANCE then
                for _, obj in pairs(espData) do
                    if obj then obj.Visible = false end
                end
                continue
            end
            
            -- Atualizar cores baseado no time
            local isEnemyPlayer = isEnemy(player)
            local boxColor = isEnemyPlayer and ESP_SETTINGS.BOX_COLOR_ENEMY or ESP_SETTINGS.BOX_COLOR_TEAM
            
            -- Atualizar Box
            if espData.box then
                espData.box.Visible = ESP_SETTINGS.SHOW_BOX and ESP_SETTINGS.ENABLED
                espData.box.Color3 = boxColor
            end
            
            -- Atualizar Nome
            if espData.nameLabel then
                espData.nameLabel.Enabled = ESP_SETTINGS.SHOW_NAME and ESP_SETTINGS.ENABLED
                local textLabel = espData.nameLabel:FindFirstChildWhichIsA("TextLabel")
                if textLabel then
                    textLabel.TextColor3 = boxColor
                end
            end
            
            -- Atualizar Distância
            if espData.distanceLabel then
                espData.distanceLabel.Enabled = ESP_SETTINGS.SHOW_DISTANCE and ESP_SETTINGS.ENABLED
                local textLabel = espData.distanceLabel:FindFirstChildWhichIsA("TextLabel")
                if textLabel then
                    textLabel.Text = tostring(distance) .. " studs"
                    textLabel.TextColor3 = boxColor
                end
            end
            
            -- Atualizar Tracer
            if espData.tracer and ESP_SETTINGS.SHOW_TRACER then
                -- Implementação do tracer (opcional)
            end
            
        else
            -- Esconder se não tiver character
            for _, obj in pairs(espData) do
                if obj then obj.Visible = false end
            end
        end
    end
end

-- Gerenciar players
local function onPlayerAdded(player)
    if player == localPlayer then return end
    
    player.CharacterAdded:Connect(function()
        wait(1) -- Aguardar character carregar completamente
        createESP(player)
    end)
    
    player.CharacterRemoving:Connect(function()
        removeESP(player)
    end)
    
    if player.Character then
        createESP(player)
    end
end

local function onPlayerRemoving(player)
    removeESP(player)
end

-- Inicializar para players existentes
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= localPlayer then
        onPlayerAdded(player)
    end
end

Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Loop de atualização
RunService.RenderStepped:Connect(updateESP)

-- Comandos no chat (opcional)
local function onChatMessage(message)
    if message:lower() == "/esp on" then
        ESP_SETTINGS.ENABLED = true
    elseif message:lower() == "/esp off" then
        ESP_SETTINGS.ENABLED = false
    elseif message:lower() == "/esp toggle" then
        ESP_SETTINGS.ENABLED = not ESP_SETTINGS.ENABLED
    end
end

localPlayer.Chatted:Connect(onChatMessage)

print("Universal ESP carregado! Comandos: /esp on, /esp off, /esp toggle")
